{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://bmad.dev/schemas/task-implementation-plan/v1.0.0",
  "title": "Task Implementation Plan",
  "description": "Schema for YAML-based task implementation plans used in agentic coding loops with TDD methodology",
  "type": "object",
  "required": ["metadata", "task"],
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Metadata about this implementation plan",
      "required": ["version", "created_date", "last_updated", "author"],
      "properties": {
        "version": {
          "type": "string",
          "description": "Semantic version of this plan (e.g., '1.0.0')",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "created_date": {
          "type": "string",
          "description": "ISO 8601 date when plan was created (YYYY-MM-DD)",
          "format": "date"
        },
        "last_updated": {
          "type": "string",
          "description": "ISO 8601 date when plan was last modified (YYYY-MM-DD)",
          "format": "date"
        },
        "author": {
          "type": "string",
          "description": "Author or system that created this plan"
        },
        "license": {
          "type": ["string", "null"],
          "description": "SPDX license identifier if LICENSE.md exists (e.g., 'MIT', 'Apache-2.0'), otherwise null"
        }
      },
      "additionalProperties": false
    },
    "task": {
      "type": "object",
      "description": "The main task to be implemented",
      "required": ["name", "description", "status", "phases"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Short, descriptive task name",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "description": "Complete, detailed multi-line description of the task including context, architecture decisions, and success criteria",
          "minLength": 1
        },
        "status": {
          "type": "string",
          "description": "Current status of the task",
          "enum": ["pending", "active", "blocked", "done"]
        },
        "blocked_reason": {
          "type": "string",
          "description": "REQUIRED if status is 'blocked'. Explains why the task is blocked.",
          "minLength": 1
        },
        "phases": {
          "type": "array",
          "description": "Implementation phases for this task",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/phase"
          }
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "status": {
                "const": "blocked"
              }
            }
          },
          "then": {
            "required": ["blocked_reason"]
          }
        }
      ]
    }
  },
  "additionalProperties": false,
  "definitions": {
    "phase": {
      "type": "object",
      "description": "A major phase of implementation",
      "required": ["id", "name", "description", "status"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier (e.g., 'phase-1', 'phase-2-sub-1')",
          "pattern": "^phase-[0-9]+((-sub)?-[0-9]+)*$"
        },
        "name": {
          "type": "string",
          "description": "Phase name",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "description": "Complete description of what this phase accomplishes",
          "minLength": 1
        },
        "status": {
          "type": "string",
          "description": "Current status of the phase",
          "enum": ["pending", "active", "blocked", "done"]
        },
        "blocked_reason": {
          "type": "string",
          "description": "REQUIRED if status is 'blocked'",
          "minLength": 1
        },
        "steps": {
          "type": "array",
          "description": "Steps within this phase",
          "items": {
            "$ref": "#/definitions/step"
          }
        },
        "sub_phases": {
          "type": "array",
          "description": "Optional nested sub-phases for complex phases",
          "items": {
            "$ref": "#/definitions/phase"
          }
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "status": {
                "const": "blocked"
              }
            }
          },
          "then": {
            "required": ["blocked_reason"]
          }
        }
      ],
      "anyOf": [
        {
          "required": ["steps"]
        },
        {
          "required": ["sub_phases"]
        }
      ]
    },
    "step": {
      "type": "object",
      "description": "A discrete step within a phase",
      "required": ["id", "name", "description", "status", "instructions"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier (e.g., 'step-1.1', 'step-2-sub-1.3')",
          "pattern": "^step-[0-9]+((-sub)?-[0-9]+)*\\.[0-9]+$"
        },
        "name": {
          "type": "string",
          "description": "Step name",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "description": "What this step accomplishes",
          "minLength": 1
        },
        "status": {
          "type": "string",
          "description": "Current status of the step",
          "enum": ["pending", "active", "blocked", "done"]
        },
        "blocked_reason": {
          "type": "string",
          "description": "REQUIRED if status is 'blocked'",
          "minLength": 1
        },
        "instructions": {
          "type": "array",
          "description": "Detailed instructions for this step",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/instruction"
          }
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "status": {
                "const": "blocked"
              }
            }
          },
          "then": {
            "required": ["blocked_reason"]
          }
        }
      ]
    },
    "instruction": {
      "type": "object",
      "description": "A single, atomic instruction with all context needed for implementation",
      "required": ["id", "content", "status"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier (e.g., 'instr-1.2.3', 'instr-2-sub-1.1.2')",
          "pattern": "^instr-[0-9]+((-sub)?-[0-9]+)*\\.[0-9]+\\.[0-9]+$"
        },
        "content": {
          "type": "string",
          "description": "Dense, multi-line instruction content including file paths, code snippets, TDD steps, references, and validation criteria",
          "minLength": 1
        },
        "status": {
          "type": "string",
          "description": "Current status of the instruction",
          "enum": ["pending", "active", "blocked", "done"]
        },
        "blocked_reason": {
          "type": "string",
          "description": "REQUIRED if status is 'blocked'",
          "minLength": 1
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "status": {
                "const": "blocked"
              }
            }
          },
          "then": {
            "required": ["blocked_reason"]
          }
        }
      ]
    }
  }
}
