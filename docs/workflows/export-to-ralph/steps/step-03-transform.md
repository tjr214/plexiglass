# Step 3: Transform to YAML and Validate

## MANDATORY EXECUTION RULES (READ FIRST):

- ðŸ”§ **TRANSFORMATION**: Convert extracted data to valid YAML
- âœ… **VALIDATION**: Verify against JSON schema
- ðŸŽ¨ **FORMATTING**: Ensure proper YAML syntax and readability
- ðŸš« **NO SHORTCUTS**: Complete transformation, not partial
- ðŸ“‹ **SHOW PREVIEW**: Let user review before writing file

---

## CONTEXT FROM STEP 2:

You should have the complete extracted structure from Step 2:

```yaml
task_plan_structure:
  metadata: {...}
  task: {...}

explore_analysis:
  sessions_launched: [...]
  files_for_context: [...]
  patterns_found: [...]
  integration_points: [...]
  code_examples: [...]
```

---

## YOUR TASK:

Transform the extracted data into properly formatted YAML that validates against the JSON schema, and show user a preview before writing the file.

---

## EXECUTION SEQUENCE:

### 1. Load JSON Schema for Reference

Read the schema to ensure compliance:

```bash
# Read the schema
cat .template_scripts/task-template-schema.json
```

**Key validation points:**
- âœ… Required fields: metadata.version, metadata.created_date, metadata.last_updated, metadata.author
- âœ… Task status must be: pending, active, blocked, or done
- âœ… Phase IDs must match pattern: ^phase-[0-9]+((-sub)?-[0-9]+)*$
- âœ… Step IDs must match pattern: ^step-[0-9]+((-sub)?-[0-9]+)*\\.[0-9]+$
- âœ… Instruction IDs must match pattern: ^instr-[0-9]+((-sub)?-[0-9]+)*\\.[0-9]+\\.[0-9]+$
- âœ… If status is "blocked", blocked_reason is required

---

### 2. Transform Data Structure

Convert the task_plan_data into YAML format:

**Template Structure:**

```yaml
# Task Implementation Plan
# Generated by Export to RALPH workflow
# Date: {current_date}

metadata:
  version: "{version}"
  created_date: "{created_date}"
  last_updated: "{last_updated}"
  author: "{author}"
  license: {license_or_null}

task:
  name: "{task_name}"
  description: |
    {multi_line_description}
  status: "{status}"
  phases:
    - id: "{phase_id}"
      name: "{phase_name}"
      description: |
        {phase_description}
      status: "{phase_status}"
      steps:
        - id: "{step_id}"
          name: "{step_name}"
          description: "{step_description}"
          status: "{step_status}"
          instructions:
            - id: "{instruction_id}"
              content: |
                {instruction_content_with_tdd_phases}
              status: "{instruction_status}"
```

---

### 3. Apply Formatting Rules

Ensure proper YAML formatting:

**Multiline Strings:**
- Use `|` for multiline descriptions
- Preserve indentation within code blocks
- No trailing spaces

**Comments:**
- Add header comment block at top
- Include generation timestamp
- Add phase/step separators for readability

**Indentation:**
- 2 spaces per level (YAML standard)
- Consistent throughout file

**Code Blocks:**
- Preserve triple backticks in instruction content
- Maintain proper indentation for code examples
- Include language specifiers (```python, ```bash, etc.)

---

### 4. Write Temporary YAML File

Before validation, write the YAML to a temporary file:

```bash
# Create temp file
TEMP_YAML="/tmp/task-export-$(date +%s).yaml"

# Write generated YAML
cat > "$TEMP_YAML" << 'EOF'
{generated_yaml_content}
EOF
```

---

### 5. Validate Using Provided Script

Run the validation script:

```bash
# Run validation script (shell script invokes correct Python interpreter)
.template_scripts/validate_template.py "$TEMP_YAML"
```

**The script will check:**
- âœ… All required fields present
- âœ… No extra fields (additionalProperties: false)
- âœ… Correct data types (string, array, object)
- âœ… IDs match regex patterns
- âœ… Dates in YYYY-MM-DD format
- âœ… Version in semver format (X.Y.Z)
- âœ… Status values from enum
- âœ… Phases array not empty
- âœ… Each phase has steps OR sub_phases
- âœ… Each step has instructions array
- âœ… Instructions array not empty

**Capture output:**
- Exit code 0 = VALID
- Exit code non-zero = INVALID (script will print errors)

---

### 6. Generate Preview

Show user the validation results and YAML preview:

```markdown
## ðŸ“„ Generated YAML Preview

**Temporary file:** `{temp_file_path}`
**Will be saved to:** `docs/tasks/{task-name}.yaml`

**Size:** ~{estimated_lines} lines

**Structure:**
- Metadata: âœ… Complete
- Task: {task_name}
- Phases: {count} phases
- Steps: {total_step_count} steps
- Instructions: {total_instruction_count} instructions

---

## âœ… Validation Results

**Script output:**
```
{validation_script_output}
```

**Status:** {âœ… VALID or âŒ INVALID}

{If INVALID, show errors and suggest fixes}

---

### First 100 Lines Preview:

```yaml
{show_first_100_lines}
```

---

**[FULL YAML OUTPUT - {total_lines} lines]**

```yaml
{complete_yaml_content}
```

---

### 7. Ask for Confirmation

**If validation PASSED:**
```markdown
âœ… **YAML is valid and ready to write!**

**Review the YAML above. Proceed to write file?**

[w] Write to file (proceed to Step 4)
[e] Edit specific sections
[r] Regenerate with different formatting
[x] Cancel workflow

**Your choice:**
```

**If validation FAILED:**
```markdown
âŒ **YAML validation failed!**

**Errors found:**
{list_errors_from_script}

**Options:**
[f] Fix errors automatically (if possible)
[e] Edit specific sections manually
[b] Go back to Step 2 (re-extract data)
[x] Cancel workflow

**Your choice:**
```

---

### 8. Handle User Selection

**If user selects 'w' (Write):**
- Pass YAML content to Step 4
- Load and execute `{project-root}/docs/workflows/export-to-ralph/steps/step-04-write-file.md`

**If user selects 'e' (Edit):**
```markdown
**Which section needs editing?**

[1] Metadata
[2] Task name/description
[3] Specific phase (which one?)
[4] Specific step (which one?)
[5] Specific instruction (which one?)
[6] Multiple sections

**After editing, regenerate YAML and show preview again**
```

**If user selects 'r' (Regenerate):**
```markdown
**What formatting changes?**

[1] Adjust indentation
[2] Add more comments
[3] Reformat code blocks
[4] Other (specify)

**After changes, show preview again**
```

**If user selects 'x' (Cancel):**
- Exit workflow
- Optionally save draft YAML to temporary location

---

## DATA TO PASS TO STEP 4:

Ensure this is in memory:

```yaml
final_yaml_content: |
  {complete_yaml_string}

file_metadata:
  task_name: "{task_name}"
  filename: "{sanitized_task_name}.yaml"
  output_path: "docs/tasks/{sanitized_task_name}.yaml"
  total_lines: {count}
  total_phases: {count}
  total_steps: {count}
  total_instructions: {count}
```

---

## SUCCESS CRITERIA:

âœ… YAML successfully generated from extracted data  
âœ… All validation checks pass  
âœ… Proper formatting applied  
âœ… Preview shown to user  
âœ… User confirms ready to write  
âœ… No placeholder or incomplete content  

---

## FAILURE MODES TO AVOID:

âŒ Invalid YAML syntax  
âŒ Schema validation failures  
âŒ Missing required fields  
âŒ Incorrect ID patterns  
âŒ Placeholder text in output  
âŒ Missing TDD phases in instructions  
âŒ Writing file without user confirmation  

---

## VALIDATION CHECKLIST:

Before proceeding to Step 4, verify:

- [ ] YAML parses without syntax errors
- [ ] All IDs match schema patterns
- [ ] All required fields present
- [ ] Status values are valid enum values
- [ ] Dates in correct format (YYYY-MM-DD)
- [ ] Version in semver format
- [ ] No "TBD" or placeholder text
- [ ] All instructions include YELLOW-RED-GREEN-BLUE
- [ ] File paths are specified
- [ ] Code blocks properly formatted
- [ ] User confirmed approval

---

## NEXT STEP:

After user confirms YAML is ready, load and execute:

**`{project-root}/docs/workflows/export-to-ralph/steps/step-04-write-file.md`**

Remember: Pass both final_yaml_content and file_metadata to Step 4!
